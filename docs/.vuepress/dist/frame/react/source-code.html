<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React 的源码流程 | Front-End-Basics</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="陈方旭的个人文档">
    
    <link rel="preload" href="/assets/css/0.styles.8f3dca9f.css" as="style"><link rel="preload" href="/assets/js/app.f0c3bf6e.js" as="script"><link rel="preload" href="/assets/js/2.267df354.js" as="script"><link rel="preload" href="/assets/js/1.66cc43cf.js" as="script"><link rel="preload" href="/assets/js/142.909571e7.js" as="script"><link rel="prefetch" href="/assets/js/10.8ed5e327.js"><link rel="prefetch" href="/assets/js/100.ae5b3443.js"><link rel="prefetch" href="/assets/js/101.cc73b0f5.js"><link rel="prefetch" href="/assets/js/102.3f3114fb.js"><link rel="prefetch" href="/assets/js/103.8ff5fdac.js"><link rel="prefetch" href="/assets/js/104.b5debdc3.js"><link rel="prefetch" href="/assets/js/105.8da11418.js"><link rel="prefetch" href="/assets/js/106.4dbe9edc.js"><link rel="prefetch" href="/assets/js/107.181bae05.js"><link rel="prefetch" href="/assets/js/108.89a63e22.js"><link rel="prefetch" href="/assets/js/109.ce54155a.js"><link rel="prefetch" href="/assets/js/11.066e1c25.js"><link rel="prefetch" href="/assets/js/110.f2e608ea.js"><link rel="prefetch" href="/assets/js/111.42921b66.js"><link rel="prefetch" href="/assets/js/112.8da31ceb.js"><link rel="prefetch" href="/assets/js/113.5ac3f0d4.js"><link rel="prefetch" href="/assets/js/114.e056e614.js"><link rel="prefetch" href="/assets/js/115.cebf7fde.js"><link rel="prefetch" href="/assets/js/116.2b434a84.js"><link rel="prefetch" href="/assets/js/117.100c132f.js"><link rel="prefetch" href="/assets/js/118.a4afed9a.js"><link rel="prefetch" href="/assets/js/119.f0f1a25d.js"><link rel="prefetch" href="/assets/js/12.9fe465cb.js"><link rel="prefetch" href="/assets/js/120.376850c5.js"><link rel="prefetch" href="/assets/js/121.5dc1a6a2.js"><link rel="prefetch" href="/assets/js/122.363693fb.js"><link rel="prefetch" href="/assets/js/123.7258fb95.js"><link rel="prefetch" href="/assets/js/124.a4bd3167.js"><link rel="prefetch" href="/assets/js/125.8aa8db7c.js"><link rel="prefetch" href="/assets/js/126.2caa71e3.js"><link rel="prefetch" href="/assets/js/127.220486dd.js"><link rel="prefetch" href="/assets/js/128.b01fb70e.js"><link rel="prefetch" href="/assets/js/129.bd8c1b32.js"><link rel="prefetch" href="/assets/js/13.ceec992d.js"><link rel="prefetch" href="/assets/js/130.9b3fd30c.js"><link rel="prefetch" href="/assets/js/131.c1e91c2d.js"><link rel="prefetch" href="/assets/js/132.6d39b36b.js"><link rel="prefetch" href="/assets/js/133.cc4ee14d.js"><link rel="prefetch" href="/assets/js/134.3b031de3.js"><link rel="prefetch" href="/assets/js/135.329aa943.js"><link rel="prefetch" href="/assets/js/136.e97d2b91.js"><link rel="prefetch" href="/assets/js/137.70ad5edc.js"><link rel="prefetch" href="/assets/js/138.b2388813.js"><link rel="prefetch" href="/assets/js/139.260e94e8.js"><link rel="prefetch" href="/assets/js/14.6b9e2f92.js"><link rel="prefetch" href="/assets/js/140.d0752482.js"><link rel="prefetch" href="/assets/js/141.c3809389.js"><link rel="prefetch" href="/assets/js/143.9c55503a.js"><link rel="prefetch" href="/assets/js/144.037eb178.js"><link rel="prefetch" href="/assets/js/145.b15eb629.js"><link rel="prefetch" href="/assets/js/146.92f941e0.js"><link rel="prefetch" href="/assets/js/147.ee679e8f.js"><link rel="prefetch" href="/assets/js/148.259bd94c.js"><link rel="prefetch" href="/assets/js/149.0560570b.js"><link rel="prefetch" href="/assets/js/15.d25af981.js"><link rel="prefetch" href="/assets/js/150.e0970997.js"><link rel="prefetch" href="/assets/js/151.8c91c562.js"><link rel="prefetch" href="/assets/js/152.b2680c3d.js"><link rel="prefetch" href="/assets/js/153.43d5659d.js"><link rel="prefetch" href="/assets/js/154.41332198.js"><link rel="prefetch" href="/assets/js/155.36a0da41.js"><link rel="prefetch" href="/assets/js/156.8d9c6ad6.js"><link rel="prefetch" href="/assets/js/157.016cc281.js"><link rel="prefetch" href="/assets/js/158.c846bda8.js"><link rel="prefetch" href="/assets/js/159.60ef4fd7.js"><link rel="prefetch" href="/assets/js/16.fe68c618.js"><link rel="prefetch" href="/assets/js/160.e000f0e7.js"><link rel="prefetch" href="/assets/js/161.f67efc97.js"><link rel="prefetch" href="/assets/js/162.4eadc328.js"><link rel="prefetch" href="/assets/js/163.39e9bbe6.js"><link rel="prefetch" href="/assets/js/164.8e990d4c.js"><link rel="prefetch" href="/assets/js/165.9cc5569d.js"><link rel="prefetch" href="/assets/js/166.dcfd67ce.js"><link rel="prefetch" href="/assets/js/167.0a12942f.js"><link rel="prefetch" href="/assets/js/168.db0cf4d8.js"><link rel="prefetch" href="/assets/js/169.0177438a.js"><link rel="prefetch" href="/assets/js/17.de0b324b.js"><link rel="prefetch" href="/assets/js/170.799f7bf1.js"><link rel="prefetch" href="/assets/js/171.72b504b4.js"><link rel="prefetch" href="/assets/js/172.3fedbd3b.js"><link rel="prefetch" href="/assets/js/173.9d2d86ef.js"><link rel="prefetch" href="/assets/js/174.1a15c5a7.js"><link rel="prefetch" href="/assets/js/175.62da2bad.js"><link rel="prefetch" href="/assets/js/176.fa85299a.js"><link rel="prefetch" href="/assets/js/177.a4f8a83d.js"><link rel="prefetch" href="/assets/js/178.3da2977b.js"><link rel="prefetch" href="/assets/js/179.5a0698c9.js"><link rel="prefetch" href="/assets/js/18.75c085a9.js"><link rel="prefetch" href="/assets/js/180.b3c22f44.js"><link rel="prefetch" href="/assets/js/181.258acfab.js"><link rel="prefetch" href="/assets/js/182.3b612a1c.js"><link rel="prefetch" href="/assets/js/183.04d35baf.js"><link rel="prefetch" href="/assets/js/184.2f6ebfb6.js"><link rel="prefetch" href="/assets/js/185.3d2ba522.js"><link rel="prefetch" href="/assets/js/186.85211aa8.js"><link rel="prefetch" href="/assets/js/187.3a727290.js"><link rel="prefetch" href="/assets/js/188.39112337.js"><link rel="prefetch" href="/assets/js/189.160e194c.js"><link rel="prefetch" href="/assets/js/19.7d112bce.js"><link rel="prefetch" href="/assets/js/190.c053d7a2.js"><link rel="prefetch" href="/assets/js/191.22cefdac.js"><link rel="prefetch" href="/assets/js/192.964f5e88.js"><link rel="prefetch" href="/assets/js/193.700abf9f.js"><link rel="prefetch" href="/assets/js/194.e267a0f1.js"><link rel="prefetch" href="/assets/js/195.e49141be.js"><link rel="prefetch" href="/assets/js/196.abd378ac.js"><link rel="prefetch" href="/assets/js/197.49b8f519.js"><link rel="prefetch" href="/assets/js/198.f60281e1.js"><link rel="prefetch" href="/assets/js/199.2444da81.js"><link rel="prefetch" href="/assets/js/20.81f5b440.js"><link rel="prefetch" href="/assets/js/200.54f5e6d4.js"><link rel="prefetch" href="/assets/js/201.132bab0f.js"><link rel="prefetch" href="/assets/js/202.cd5ef700.js"><link rel="prefetch" href="/assets/js/203.6524ae1d.js"><link rel="prefetch" href="/assets/js/204.79049883.js"><link rel="prefetch" href="/assets/js/205.b453ac0d.js"><link rel="prefetch" href="/assets/js/206.8e68e3cb.js"><link rel="prefetch" href="/assets/js/207.0dbf0bb5.js"><link rel="prefetch" href="/assets/js/208.a6f0aa62.js"><link rel="prefetch" href="/assets/js/209.5eb00898.js"><link rel="prefetch" href="/assets/js/21.b8f03079.js"><link rel="prefetch" href="/assets/js/210.5394d572.js"><link rel="prefetch" href="/assets/js/211.4d73566d.js"><link rel="prefetch" href="/assets/js/212.01ea7dd7.js"><link rel="prefetch" href="/assets/js/213.80261d17.js"><link rel="prefetch" href="/assets/js/214.42974ae8.js"><link rel="prefetch" href="/assets/js/215.6a9aefd7.js"><link rel="prefetch" href="/assets/js/216.71698897.js"><link rel="prefetch" href="/assets/js/217.cbdb7908.js"><link rel="prefetch" href="/assets/js/218.e1ca46a4.js"><link rel="prefetch" href="/assets/js/219.4bff8927.js"><link rel="prefetch" href="/assets/js/22.ce37cd53.js"><link rel="prefetch" href="/assets/js/220.d29e2c08.js"><link rel="prefetch" href="/assets/js/221.6a2c607c.js"><link rel="prefetch" href="/assets/js/222.7209db02.js"><link rel="prefetch" href="/assets/js/223.18f8b9df.js"><link rel="prefetch" href="/assets/js/224.52b820e0.js"><link rel="prefetch" href="/assets/js/225.46e90caa.js"><link rel="prefetch" href="/assets/js/226.63ed554a.js"><link rel="prefetch" href="/assets/js/227.7fafc4da.js"><link rel="prefetch" href="/assets/js/228.7706dc54.js"><link rel="prefetch" href="/assets/js/229.842a1964.js"><link rel="prefetch" href="/assets/js/23.87e7e45e.js"><link rel="prefetch" href="/assets/js/230.ddc0f55a.js"><link rel="prefetch" href="/assets/js/231.e72fa0a7.js"><link rel="prefetch" href="/assets/js/232.e15e10a1.js"><link rel="prefetch" href="/assets/js/233.9001d006.js"><link rel="prefetch" href="/assets/js/234.c55b49d9.js"><link rel="prefetch" href="/assets/js/235.da1bf5f9.js"><link rel="prefetch" href="/assets/js/236.9efb932c.js"><link rel="prefetch" href="/assets/js/237.67412574.js"><link rel="prefetch" href="/assets/js/238.24ef619f.js"><link rel="prefetch" href="/assets/js/239.1f2a6298.js"><link rel="prefetch" href="/assets/js/24.5aa30e8d.js"><link rel="prefetch" href="/assets/js/240.9c9279b1.js"><link rel="prefetch" href="/assets/js/241.695630cd.js"><link rel="prefetch" href="/assets/js/242.891e7aef.js"><link rel="prefetch" href="/assets/js/243.edd26862.js"><link rel="prefetch" href="/assets/js/244.ed576d71.js"><link rel="prefetch" href="/assets/js/245.d10042cf.js"><link rel="prefetch" href="/assets/js/246.d57006a7.js"><link rel="prefetch" href="/assets/js/247.b2d6742e.js"><link rel="prefetch" href="/assets/js/248.8b56d853.js"><link rel="prefetch" href="/assets/js/249.b8fc1805.js"><link rel="prefetch" href="/assets/js/25.5c7b2cfe.js"><link rel="prefetch" href="/assets/js/250.1aad43ae.js"><link rel="prefetch" href="/assets/js/251.be9db929.js"><link rel="prefetch" href="/assets/js/252.afedca09.js"><link rel="prefetch" href="/assets/js/253.c6e86855.js"><link rel="prefetch" href="/assets/js/254.90b4f52a.js"><link rel="prefetch" href="/assets/js/255.227c9c47.js"><link rel="prefetch" href="/assets/js/256.fe3714d4.js"><link rel="prefetch" href="/assets/js/257.3e5db4f7.js"><link rel="prefetch" href="/assets/js/258.29013d06.js"><link rel="prefetch" href="/assets/js/259.e9af4b51.js"><link rel="prefetch" href="/assets/js/26.5a8e32e6.js"><link rel="prefetch" href="/assets/js/260.9555612d.js"><link rel="prefetch" href="/assets/js/261.e8e200a0.js"><link rel="prefetch" href="/assets/js/262.0f393806.js"><link rel="prefetch" href="/assets/js/263.42b99650.js"><link rel="prefetch" href="/assets/js/264.5e36cccd.js"><link rel="prefetch" href="/assets/js/265.e7759e0e.js"><link rel="prefetch" href="/assets/js/266.2bce58fa.js"><link rel="prefetch" href="/assets/js/267.6e2a5a40.js"><link rel="prefetch" href="/assets/js/27.997b1485.js"><link rel="prefetch" href="/assets/js/28.ef6638c6.js"><link rel="prefetch" href="/assets/js/29.c9d728b9.js"><link rel="prefetch" href="/assets/js/3.dc3407e1.js"><link rel="prefetch" href="/assets/js/30.d873fb03.js"><link rel="prefetch" href="/assets/js/31.2bf741ce.js"><link rel="prefetch" href="/assets/js/32.551ac32b.js"><link rel="prefetch" href="/assets/js/33.b6573b5c.js"><link rel="prefetch" href="/assets/js/34.b46900a8.js"><link rel="prefetch" href="/assets/js/35.f131466c.js"><link rel="prefetch" href="/assets/js/36.89942ede.js"><link rel="prefetch" href="/assets/js/37.0e54922b.js"><link rel="prefetch" href="/assets/js/38.36f714a1.js"><link rel="prefetch" href="/assets/js/39.2256d2d3.js"><link rel="prefetch" href="/assets/js/4.43d53c19.js"><link rel="prefetch" href="/assets/js/40.784c879e.js"><link rel="prefetch" href="/assets/js/41.8bac5a7b.js"><link rel="prefetch" href="/assets/js/42.b6e7fc8b.js"><link rel="prefetch" href="/assets/js/43.ab92dcea.js"><link rel="prefetch" href="/assets/js/44.666a8d67.js"><link rel="prefetch" href="/assets/js/45.23a7d54d.js"><link rel="prefetch" href="/assets/js/46.c90bff29.js"><link rel="prefetch" href="/assets/js/47.b109dec7.js"><link rel="prefetch" href="/assets/js/48.7f766765.js"><link rel="prefetch" href="/assets/js/49.0a8e763d.js"><link rel="prefetch" href="/assets/js/5.b6321aed.js"><link rel="prefetch" href="/assets/js/50.686d1521.js"><link rel="prefetch" href="/assets/js/51.9936e373.js"><link rel="prefetch" href="/assets/js/52.f0b789de.js"><link rel="prefetch" href="/assets/js/53.5438164d.js"><link rel="prefetch" href="/assets/js/54.ec6f1f74.js"><link rel="prefetch" href="/assets/js/55.002caceb.js"><link rel="prefetch" href="/assets/js/56.d7896533.js"><link rel="prefetch" href="/assets/js/57.560f886c.js"><link rel="prefetch" href="/assets/js/58.ede39d55.js"><link rel="prefetch" href="/assets/js/59.f8e25f0e.js"><link rel="prefetch" href="/assets/js/6.8dc86351.js"><link rel="prefetch" href="/assets/js/60.16e85fb0.js"><link rel="prefetch" href="/assets/js/61.c4a68cdb.js"><link rel="prefetch" href="/assets/js/62.b8285ec7.js"><link rel="prefetch" href="/assets/js/63.cea2c4d9.js"><link rel="prefetch" href="/assets/js/64.33d06366.js"><link rel="prefetch" href="/assets/js/65.7dacc788.js"><link rel="prefetch" href="/assets/js/66.1c982721.js"><link rel="prefetch" href="/assets/js/67.5509334e.js"><link rel="prefetch" href="/assets/js/68.f9deb190.js"><link rel="prefetch" href="/assets/js/69.fd052a09.js"><link rel="prefetch" href="/assets/js/7.4de4dc57.js"><link rel="prefetch" href="/assets/js/70.b36ecec1.js"><link rel="prefetch" href="/assets/js/71.09472ede.js"><link rel="prefetch" href="/assets/js/72.7fc03c28.js"><link rel="prefetch" href="/assets/js/73.1df4ed7b.js"><link rel="prefetch" href="/assets/js/74.eef842dd.js"><link rel="prefetch" href="/assets/js/75.a4642706.js"><link rel="prefetch" href="/assets/js/76.2921120f.js"><link rel="prefetch" href="/assets/js/77.8959d3b8.js"><link rel="prefetch" href="/assets/js/78.15af67c9.js"><link rel="prefetch" href="/assets/js/79.ca2b3995.js"><link rel="prefetch" href="/assets/js/80.86253068.js"><link rel="prefetch" href="/assets/js/81.4dfb5100.js"><link rel="prefetch" href="/assets/js/82.40f05690.js"><link rel="prefetch" href="/assets/js/83.ae59f017.js"><link rel="prefetch" href="/assets/js/84.a16c2086.js"><link rel="prefetch" href="/assets/js/85.78764153.js"><link rel="prefetch" href="/assets/js/86.6da75781.js"><link rel="prefetch" href="/assets/js/87.9093c83e.js"><link rel="prefetch" href="/assets/js/88.1b71ff61.js"><link rel="prefetch" href="/assets/js/89.c3298594.js"><link rel="prefetch" href="/assets/js/90.dbab72f7.js"><link rel="prefetch" href="/assets/js/91.201c3950.js"><link rel="prefetch" href="/assets/js/92.23d20e66.js"><link rel="prefetch" href="/assets/js/93.35dc98bf.js"><link rel="prefetch" href="/assets/js/94.da768453.js"><link rel="prefetch" href="/assets/js/95.9767a2ff.js"><link rel="prefetch" href="/assets/js/96.890fcdc4.js"><link rel="prefetch" href="/assets/js/97.4bdcd3d5.js"><link rel="prefetch" href="/assets/js/98.972a16fd.js"><link rel="prefetch" href="/assets/js/99.44f9b5d3.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.a900b7e8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8f3dca9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Front-End-Basics" class="logo"> <span class="site-name can-hide">Front-End-Basics</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/article/" class="nav-link">
  捡贝壳
</a></div> <a href="https://github.com/qiqihaobenben/Front-End-Basics" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/article/" class="nav-link">
  捡贝壳
</a></div> <a href="https://github.com/qiqihaobenben/Front-End-Basics" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/html/global-attr.html" class="sidebar-link">HTML</a></li><li><a href="/css/theory/typesetting.html" class="sidebar-link">CSS</a></li><li><a href="/javascript/utility/lexical-grammar.html" class="sidebar-link">JavaScript</a></li><li><a href="/infrastructure/vscode-code-format.html" class="sidebar-link">基础建设和工程化</a></li><li><a href="/career/plan-2022.html" class="sidebar-link">职业发展</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>移动端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>服务端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/nodejs/basic.html" class="sidebar-link">NodeJS</a></li><li><a href="/network-basics/http/into.html" class="sidebar-link">网络基础</a></li><li><a href="/database/mysql/mysql.html" class="sidebar-link">数据存储</a></li><li><a href="/server/linux/computer.html" class="sidebar-link">服务器运维</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>开发工具</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>认知</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react-的源码流程"><a href="#react-的源码流程" class="header-anchor">#</a> React 的源码流程</h1> <p>React 的源码架构分为三个部分：</p> <ul><li>调度器（Scheduler）：调度任务的优先级，高优任务优先进入 Reconciler</li> <li>协调器（Reconciler）：VDOM 的实现，负责根据自变量变化计算出 UI 变化，简单的说就是找出变化的组件</li> <li>渲染器（Renderer）：负责将变化的组件渲染到页面上</li></ul> <h2 id="同步更新流程-shouldtimeslice-为-false"><a href="#同步更新流程-shouldtimeslice-为-false" class="header-anchor">#</a> 同步更新流程（shouldTimeSlice 为 false）</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createRoot <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-dom'</span>
<span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'app'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">createRoot</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span>

root<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="reactdom-createroot"><a href="#reactdom-createroot" class="header-anchor">#</a> ReactDOM.createRoot</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 参数：</span>
<span class="token comment">// container：DOM 元素，React 组件树将在其中进行渲染。</span>
<span class="token comment">// options：可选配置对象，包括如何处理 Hydration 等。</span>
<span class="token keyword">function</span> <span class="token function">createRoot</span><span class="token punctuation">(</span><span class="token parameter">container<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> hydrate <span class="token operator">=</span> options <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>hydrate <span class="token operator">===</span> <span class="token boolean">true</span>
  <span class="token keyword">var</span> hydrationCallbacks <span class="token operator">=</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>hydrationOptions<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">null</span>

  <span class="token keyword">var</span> isStrictMode <span class="token operator">=</span> options <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>unstable_strictMode <span class="token operator">===</span> <span class="token boolean">true</span>
  <span class="token comment">// 生成 FiberRootNode 和 HostRootFiber</span>
  <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> ConcurrentRoot<span class="token punctuation">,</span> hydrate<span class="token punctuation">,</span> hydrationCallbacks<span class="token punctuation">,</span> isStrictMode<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactDOMRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * FiberRootNode: {
 *  tag: ConcurrentRoot (就是 1)
 *  current: FiberNode（具体为 HostRootFiber）
 *  containerInfo: DOMElement（即为 createRoot 传入的 container 元素，例如 div#root）
 * }
 *
 * FiberRootNode.current 为 HostRootFiber
 * HostRootFiber: {
 *  tag: HostRoot （就是 3）
 *  stateNode: FiberRootNode （指向 FiberRootNode）
 * }
 */</span>
</code></pre></div><p><code>ReactDOM.createRoot(container, options?)</code>创建一个与 DOM 容器节点绑定的 root，称为 FiberRootNode。这个 root 负责管理 React 组件树的渲染。 返回值为 <code>new ReactDOMRoot(root)</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">ReactDOMRoot</span><span class="token punctuation">(</span><span class="token parameter">internalRoot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_internalRoot <span class="token operator">=</span> internalRoot
<span class="token punctuation">}</span>
</code></pre></div><p><code>ReactDOMRoot</code> 实例上有 <code>render</code> 方法，用于将 React 元素渲染到容器中，当项目中调用 <code>root.render(&lt;App /&gt;)</code> 时，这标志着渲染操作的开始。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//参数：</span>
<span class="token comment">// children：React元素，通常是应用的顶层组件。</span>
<span class="token class-name">ReactDOMRoot</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_internalRoot
  <span class="token keyword">var</span> container <span class="token operator">=</span> root<span class="token punctuation">.</span>containerInfo
  <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> root<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="render-阶段"><a href="#render-阶段" class="header-anchor">#</a> render 阶段</h3> <p>Reconciler 工作的阶段在 React 内部被称为 render 阶段。</p> <h4 id="updatecontainer"><a href="#updatecontainer" class="header-anchor">#</a> updateContainer</h4> <p><code>updateContainer(element, container, parentComponent, callback?)</code> 在指定的 container 中渲染或更新给定的 React 元素。</p> <ul><li>创建或更新 Fiber 节点。</li> <li>调用 schedulerUpdateOnFiber 以调度这个 Fiber 节点的更新。</li></ul> <h4 id="scheduleupdateonfiber"><a href="#scheduleupdateonfiber" class="header-anchor">#</a> scheduleUpdateOnFiber</h4> <p>scheduleUpdateOnFiber(fiber, lane, eventTime)，标记 Fiber 节点上的更新，并根据更新的优先级（lanes）安排执行。</p> <ul><li>计算更新的优先级，确定更新所在的 lane。</li> <li>根据 Fiber 节点的优先级，调用 ensureRootIsScheduled 来确保根节点的任务被调度。</li></ul> <h4 id="ensurerootisscheduled"><a href="#ensurerootisscheduled" class="header-anchor">#</a> ensureRootIsScheduled</h4> <p>ensureRootIsScheduled(root) 确保整个应用的根节点（root）有一个调度任务。</p> <ul><li>检查 root 上是否有待执行的工作。</li> <li>根据当前的调度优先级，调用 scheduler 的 schedulerCallback 进行任务调度。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> schedulerPriorityLevel

<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">lanesToEventPriority</span><span class="token punctuation">(</span>nextLanes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token literal-property property">DiscreteEventPriority</span><span class="token operator">:</span>
    schedulerPriorityLevel <span class="token operator">=</span> ImmediatePriority
    <span class="token keyword">break</span>

  <span class="token keyword">case</span> <span class="token literal-property property">ContinuousEventPriority</span><span class="token operator">:</span>
    schedulerPriorityLevel <span class="token operator">=</span> UserBlockingPriority
    <span class="token keyword">break</span>

  <span class="token keyword">case</span> <span class="token literal-property property">DefaultEventPriority</span><span class="token operator">:</span>
    schedulerPriorityLevel <span class="token operator">=</span> NormalPriority
    <span class="token keyword">break</span>

  <span class="token keyword">case</span> <span class="token literal-property property">IdleEventPriority</span><span class="token operator">:</span>
    schedulerPriorityLevel <span class="token operator">=</span> IdlePriority
    <span class="token keyword">break</span>

  <span class="token keyword">default</span><span class="token operator">:</span>
    schedulerPriorityLevel <span class="token operator">=</span> NormalPriority
    <span class="token keyword">break</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="schedulecallback"><a href="#schedulecallback" class="header-anchor">#</a> scheduleCallback</h4> <p><code>scheduleCallback(priorityLevel, callback)</code> 根据给定的优先级，安排一个回调函数在合适的时间执行。scheduleCallback 实际上是调用了 Scheduler.unstable_scheduleCallback <code>var scheduleCallback = Scheduler.unstable_scheduleCallback</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">unstable_scheduleCallback</span><span class="token punctuation">(</span><span class="token parameter">priorityLevel<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> currentTime <span class="token operator">=</span> exports<span class="token punctuation">.</span><span class="token function">unstable_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">var</span> startTime

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> options <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> delay <span class="token operator">=</span> options<span class="token punctuation">.</span>delay

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> delay <span class="token operator">===</span> <span class="token string">'number'</span> <span class="token operator">&amp;&amp;</span> delay <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      startTime <span class="token operator">=</span> currentTime <span class="token operator">+</span> delay
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      startTime <span class="token operator">=</span> currentTime
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    startTime <span class="token operator">=</span> currentTime
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> timeout

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>priorityLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ImmediatePriority</span><span class="token operator">:</span>
      timeout <span class="token operator">=</span> <span class="token constant">IMMEDIATE_PRIORITY_TIMEOUT</span>
      <span class="token keyword">break</span>

    <span class="token keyword">case</span> <span class="token literal-property property">UserBlockingPriority</span><span class="token operator">:</span>
      timeout <span class="token operator">=</span> <span class="token constant">USER_BLOCKING_PRIORITY_TIMEOUT</span>
      <span class="token keyword">break</span>

    <span class="token keyword">case</span> <span class="token literal-property property">IdlePriority</span><span class="token operator">:</span>
      timeout <span class="token operator">=</span> <span class="token constant">IDLE_PRIORITY_TIMEOUT</span>
      <span class="token keyword">break</span>

    <span class="token keyword">case</span> <span class="token literal-property property">LowPriority</span><span class="token operator">:</span>
      timeout <span class="token operator">=</span> <span class="token constant">LOW_PRIORITY_TIMEOUT</span>
      <span class="token keyword">break</span>

    <span class="token keyword">case</span> <span class="token literal-property property">NormalPriority</span><span class="token operator">:</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      timeout <span class="token operator">=</span> <span class="token constant">NORMAL_PRIORITY_TIMEOUT</span>
      <span class="token keyword">break</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> expirationTime <span class="token operator">=</span> startTime <span class="token operator">+</span> timeout
  <span class="token keyword">var</span> newTask <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> taskIdCounter<span class="token operator">++</span><span class="token punctuation">,</span>
    <span class="token literal-property property">callback</span><span class="token operator">:</span> callback<span class="token punctuation">,</span>
    <span class="token literal-property property">priorityLevel</span><span class="token operator">:</span> priorityLevel<span class="token punctuation">,</span>
    <span class="token literal-property property">startTime</span><span class="token operator">:</span> startTime<span class="token punctuation">,</span>
    <span class="token literal-property property">expirationTime</span><span class="token operator">:</span> expirationTime<span class="token punctuation">,</span>
    <span class="token literal-property property">sortIndex</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>startTime <span class="token operator">&gt;</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is a delayed task.</span>
    newTask<span class="token punctuation">.</span>sortIndex <span class="token operator">=</span> startTime
    <span class="token function">push</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">,</span> newTask<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> newTask <span class="token operator">===</span> <span class="token function">peek</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// All tasks are delayed, and this is the task with the earliest delay.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isHostTimeoutScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Cancel an existing timeout.</span>
        <span class="token function">cancelHostTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        isHostTimeoutScheduled <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span> <span class="token comment">// Schedule a timeout.</span>

      <span class="token function">requestHostTimeout</span><span class="token punctuation">(</span>handleTimeout<span class="token punctuation">,</span> startTime <span class="token operator">-</span> currentTime<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    newTask<span class="token punctuation">.</span>sortIndex <span class="token operator">=</span> expirationTime
    <span class="token function">push</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">,</span> newTask<span class="token punctuation">)</span>
    <span class="token comment">// wait until the next time we yield.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isHostCallbackScheduled <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isPerformingWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isHostCallbackScheduled <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token function">requestHostCallback</span><span class="token punctuation">(</span>flushWork<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> newTask
<span class="token punctuation">}</span>
</code></pre></div><h4 id="requesthostcallback-调用-scheduleperformworkuntildeadline"><a href="#requesthostcallback-调用-scheduleperformworkuntildeadline" class="header-anchor">#</a> requestHostCallback 调用 schedulePerformWorkUntilDeadline</h4> <p>在浏览器中使用 postMessage 技术确保尽早插入新的宏任务。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> port <span class="token operator">=</span> channel<span class="token punctuation">.</span>port2
channel<span class="token punctuation">.</span>port1<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> performWorkUntilDeadline
<span class="token function-variable function">schedulePerformWorkUntilDeadline</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="performworkuntildeadline-调用-flushwork-清空所有工作队列-执行所有剩余的工作。"><a href="#performworkuntildeadline-调用-flushwork-清空所有工作队列-执行所有剩余的工作。" class="header-anchor">#</a> performWorkUntilDeadline 调用 flushWork 清空所有工作队列，执行所有剩余的工作。</h4> <h4 id="flushwork-调用-workloop-处理所有的工作单元-直到队列清空或达到浏览器的帧限制。"><a href="#flushwork-调用-workloop-处理所有的工作单元-直到队列清空或达到浏览器的帧限制。" class="header-anchor">#</a> flushWork 调用 workLoop 处理所有的工作单元，直到队列清空或达到浏览器的帧限制。</h4> <h4 id="workloop-调用-并发地执行根节点上的工作。"><a href="#workloop-调用-并发地执行根节点上的工作。" class="header-anchor">#</a> workLoop 调用 并发地执行根节点上的工作。</h4> <p>利用 React 的 Fiber 架构并发地执行更新，允许中断和恢复。</p> <h4 id=""><a href="#" class="header-anchor">#</a></h4> <p>判断 shouldTimeSlice 为 false，调用 renderRootSync 同步渲染根节点。同步遍历 Fiber 树，执行更新，不允许任务中断。renderRootSync 会调用 workLoopSync。</p> <p>判断 shouldTimeSlice 为 true，调用 renderRootConcurrent 异步渲染根节点。异步遍历 Fiber 树，执行更新，允许任务中断。renderRootConcurrent 会调用 workLoopConcurrent。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">workLoopConcurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="renderrootsync-调用-workloopsync-同步执行工作循环。"><a href="#renderrootsync-调用-workloopsync-同步执行工作循环。" class="header-anchor">#</a> renderRootSync 调用 workLoopSync 同步执行工作循环。</h4> <h4 id="workloopsync-调用-performunitofwork"><a href="#workloopsync-调用-performunitofwork" class="header-anchor">#</a> workLoopSync 调用 performUnitOfWork</h4> <p>performUnitOfWork 方法会创建下一个 fiberNode 并赋值给 workInProgress，并将 workInProgress 与已创建的 fiberNode 连接起来构成 Fiber Tree。</p> <p>performUnitOfWork 中会调用 beginWork 和 completeWork，分别处理开始和结束工作。在遍历的过程中，会为 FiberNode 标记“代表不同副作用的 flags”，以便后续在 Renderer 中使用。</p> <h4 id="beginwork"><a href="#beginwork" class="header-anchor">#</a> beginWork</h4> <p>beginWork 首先判断当前流程属于 mount 还是 update，判断依据为 current Fiber 是否存在（<code>current !== null</code>）。</p> <p>如果当前流程为 update 流程，则 workInProgress FiberNode 存在对应的 Current FiberNode（<code>current = workInProgress.alternate</code>）。如果本次更新不影响 FiberNode.child，则可以复用对应的 Current FiberNode（<code>attemptEarlyBailoutIfNoScheduledUpdate</code>），这是一条 render 阶段的优化路径。</p> <p>如果无法复用 Current FiberNode，则 mount 和 update 的流程大体一致，包括：</p> <ul><li>根据 workInProgress.tag 进入“不同类型元素的处理分支”
<ul><li>HostComponent 代表原生 Element 类型（比如 DIV、SPAN）</li> <li>IndeterminateComponent 是 FC mount 时进入的分支，update 时则进入 FunctionComponent 分支</li> <li>HostText 代表文本元素类型</li></ul></li> <li>使用 reconcile 算法生成下一级 fiberNode
<ul><li>如果常见类型（比如 FunctionComponent、ClassComponent、HostComponent）没有命中优化策略，它们最终会调用 reconcileChildFibers 函数生成子 fiberNode</li></ul></li></ul> <p><strong>beginWork 的 mount 和 update 的区别在于：最终是否会为“生成的子 fiberNode”标记“副作用 flags”</strong></p> <h5 id="reconcilechildfibers"><a href="#reconcilechildfibers" class="header-anchor">#</a> reconcileChildFibers</h5> <p>reconcileChildFibers 负责协调（或者说更新）子 Fiber，它对比现有子 Fiber 节点与新生成的 React 元素之间的差异，决定子 Fiber 节点中哪些节点需要更新、删除或者创建，在这个方法中只是对子 Fiber 节点添加了 <code>returnFiber.flags |= ChildDeletion</code> 或 <code>newFiber.flags |= Placement</code> 这些标记。</p> <h4 id="completework"><a href="#completework" class="header-anchor">#</a> completeWork</h4> <p>completeWork 具体逻辑如下：</p> <ul><li>根据 workInProgress.tag 进入不同的分支</li> <li>在每个分支中，根据 <code>current !== null</code> 区分 mount 和 update 流程</li> <li>完成 mount 或 update 流程后，都会执行 bubbleProperties 方法完成 flags 的冒泡</li></ul> <h5 id="completework-的-mount-流程"><a href="#completework-的-mount-流程" class="header-anchor">#</a> completeWork 的 mount 流程</h5> <ul><li>例如对于 HostComponent，在 mount 流程中首先会调用 createInstance 方法创建对应的 DOM 元素</li> <li>然后执行 <code>appendAllChildren</code> 将下一级 DOM 元素挂在在上一步创建的 DOM 元素下</li> <li>执行 <code>finalizeInitialChildren</code> 完成属性的初始化
<ul><li>styles，对应 <code>setValueForStyles</code>方法</li> <li>innerHTML，对应 <code>setInnerHTML</code> 方法</li> <li>文本类型 children，对应 <code>setTextContent</code> 方法</li> <li>不会在 DOM 中冒泡的事件，包括 cancel、close、invalid、load、scroll、toggle，对应 <code>listenToNonDelegatedEvent</code> 方法</li> <li>其他属性，对应 <code>setValueForProperty</code> 方法</li></ul></li></ul> <h5 id="completework-的-update-流程"><a href="#completework-的-update-流程" class="header-anchor">#</a> completeWork 的 update 流程</h5> <ul><li>例如对于 HostComponent，在 update 流程中首先会调用 updateHostComponent 方法，主要是标记属性的更新</li> <li>如果 oldProps 和 newProps 相等，会直接 return，如果不相等，会调用 <code>diffProperties</code> 方法</li> <li><code>diffProperties</code> 方法包含两次遍历：
<ul><li>第一次遍历：标记删除“更新前有，更新后没有”的属性</li> <li>第二次遍历：标记更新“update 流程前后发生改变”的属性</li></ul></li> <li>所有变化属性的 key，value 会保存在 fiberNode.updateQueue 中，同时会标记 <code>fiberNode.flags |= Update</code></li></ul> <p>beginWork 的 reconcileChildFibers 方法用来“标记 fiberNode 的插入、删除、移动”，completeWork 方法才是真正的将 UI 的变化整理出来，例如 HostComponent 的 mount 过程，会将生成的 DOM 元素放到 workInProgress.stateNode 然后挂在到父 DOM 上，update 过程会将属性的变化放到 updateQueue 中。</p> <h4 id="completework-的上层-completeunitofwork"><a href="#completework-的上层-completeunitofwork" class="header-anchor">#</a> completeWork 的上层 completeUnitOfWork</h4> <p>completeUnitOfWork 中除了调用 completeWork 处理当前节点外，在最后会执行一下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// beginWork 执行完，next 为 null 时，进入 completeWork，completeWork 执行完，会检查是否有 sibling</span>
<span class="token keyword">var</span> siblingFiber <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>sibling
<span class="token comment">// 如果有 siblingFiber，将 workInProgress 指向 siblingFiber，重新执行 performUnitOfWork</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>siblingFiber <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  workInProgress <span class="token operator">=</span> siblingFiber
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
<span class="token comment">// 如果没有 siblingFiber ，就进行 returnFiber 的 completeWork</span>
completedWork <span class="token operator">=</span> returnFiber
workInProgress <span class="token operator">=</span> completedWork
</code></pre></div><h3 id="commit-阶段"><a href="#commit-阶段" class="header-anchor">#</a> commit 阶段</h3> <p>Renderer（渲染器）工作的阶段被称为 commit 阶段。在 commit 阶段，会将各种副作用（flags）commit（提交） 到宿主环境的 UI 中。</p> <p><strong>render 阶段流程可能会被打断，而 commit 阶段一旦开始就会同步执行直到完成</strong></p> <p>commit 工作流程分为三个阶段：</p> <ul><li>开始前的准备工作，比如判断“是否有副作用需要执行”</li> <li>处理副作用</li> <li>结束后的收尾工作，比如调度新的更新</li></ul> <p>处理副作用阶段还可以分为三个子阶段：</p> <ul><li>BeforeMutation 阶段</li> <li>Mutation 阶段</li> <li>Layout 阶段</li></ul> <p>commit 阶段的起点开始与 commitRoot 方法的调用。</p> <p>那么 commitRoot 方法在什么时候调用？</p> <p>函数会调用 renderRootSync 或 renderRootConcurrent，最后会调用 finishConcurrentRender 函数。</p> <p>renderRootSync 或 renderRootConcurrent 中调用 completeUnitOfWork 的最后，会设置 <code>workInProgressRootExitStatus = RootCompleted</code>，表示整个 workInProgress Fiber Tree 的构建完成。</p> <p>在 finishConcurrentRender 函数中判断 exitStatus 等于 RootCompleted，会调用 commitRoot 函数。</p> <h4 id="commitroot"><a href="#commitroot" class="header-anchor">#</a> commitRoot</h4> <p>commmitRoot(root) 的参数：</p> <ul><li>root 代表“本次更新所属的 FiberRootNode”</li> <li>root.finishedWork 代表 workInProgress HostRootFiber，即“render 阶段构建的 wokeInProgress Fiber Tree” 的 HostRootFiber</li></ul> <p>在三个子阶段执行之前，需要判断本次更新是否涉及“与三个子阶段相关的副作用” 逻辑如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitRootImpl</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> renderPriorityLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 省略之前代码</span>
  <span class="token keyword">var</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork
  <span class="token comment">// subtreeHasEffects 代表 workInProgress HostRootFiber 的子孙元素存在的副作用 flags</span>
  <span class="token keyword">var</span> subtreeHasEffects <span class="token operator">=</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>subtreeFlags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>BeforeMutationMask <span class="token operator">|</span> MutationMask <span class="token operator">|</span> LayoutMask <span class="token operator">|</span> PassiveMask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags
  <span class="token comment">// rootHasEffect 代表 workInProgress HostRootFiber 自身存在的副作用 flags</span>
  <span class="token keyword">var</span> rootHasEffect <span class="token operator">=</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>BeforeMutationMask <span class="token operator">|</span> MutationMask <span class="token operator">|</span> LayoutMask <span class="token operator">|</span> PassiveMask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags

  <span class="token keyword">if</span> <span class="token punctuation">(</span>subtreeHasEffects <span class="token operator">||</span> rootHasEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 本次更新存在与三个子阶段相关的副作用</span>
    <span class="token comment">// 进入 commit 阶段的三个子阶段</span>
    <span class="token keyword">var</span> shouldFireAfterActiveInstanceBlur <span class="token operator">=</span> <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span>
    <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> finishedWork<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span>
    <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 省略：本次更新没有三个子阶段的副作用</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="mask-参考"><a href="#mask-参考" class="header-anchor">#</a> mask 参考</h5> <ul><li>Update:
<ul><li>ClassComponent 存在更新，且定义了 componentDidMount 或 componentDidUpdate 方法；</li> <li>HostComponent 发生了属性变化</li> <li>HostText 发生了内容变化</li> <li>FC 定义了 useLayoutEffect</li></ul></li> <li>Snapshot： ClassComponet 存在更新，且定义了 getSnapshotBeforeUpdate 方法</li> <li>Placement：当前 fiberNode 或子孙 fiberNode 存在“需要插入或移动的 HostComponent”</li> <li>ChildDeletion：当前 fiberNode 或子孙 fiberNode 存在“需要删除的子 HostComponent 或子 HostText”</li> <li>ContentReset：清空 HostComponent 的文本内容</li> <li>Ref：HostComponent ref 属性的创建与更新</li> <li>Hydrating： hydrate 相关</li> <li>Visibility： 控制 SuspenseComponent 的子树与 fallback 切换时子树的显隐</li> <li>Callback： 当 ClassComponent 中的 this.setState 执行时，或 ReactDOM.render 执行时传递了回调函数参数</li> <li>Passive：FC 中定义了 useEffect 且需要触发回调函数</li></ul> <p>例如：</p> <div class="language- extra-class"><pre class="language-text"><code>BeforeMutationMask： Update | Snapshot | 0，代表 BeforeMutation 子阶段跟 Update 和Snapshot 相关。由于 Snapshot 是“ClassComponet 存在更新，且定义了getSnapshotBeforeUpdate 方法”后才会设置的 flags，因此可以判断 BeforeMutation 子阶段会执行 getSnapshotBeforeUpdate 方法。
</code></pre></div><h4 id="commitbeforemutationeffects"><a href="#commitbeforemutationeffects" class="header-anchor">#</a> commitBeforeMutationEffects</h4> <p>commitBeforeMutationEffects 会调用 commitBeforeMutationEffects_begin</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> firstChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 省略之前代码</span>
  nextEffect <span class="token operator">=</span> firstChild
  <span class="token function">commitBeforeMutationEffects_begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// 省略重置全局变量</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="commitbeforemutationeffects-begin-会调用-commitbeforemutationeffects-complete"><a href="#commitbeforemutationeffects-begin-会调用-commitbeforemutationeffects-complete" class="header-anchor">#</a> commitBeforeMutationEffects_begin 会调用 commitBeforeMutationEffects_complete</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitBeforeMutationEffects_begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 向下遍历直到“第一个满足如下条件之一的 fiberNode”</span>
  <span class="token comment">// 1. 当前 fiberNode 的子 fiberNode 不包含“该子阶段对应的 flags”，即当前 fiberNode 是“包含该子阶段对应的 flags”的“层级最低”的 fiberNode</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> fiber <span class="token operator">=</span> nextEffect

    <span class="token keyword">var</span> child <span class="token operator">=</span> fiber<span class="token punctuation">.</span>child

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>subtreeFlags <span class="token operator">&amp;</span> BeforeMutationMask<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags <span class="token operator">&amp;&amp;</span> child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 省略代码</span>
      nextEffect <span class="token operator">=</span> child
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">commitBeforeMutationEffects_complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// commitBeforeMutationEffects_complete 用来执行 “flags 对应的操作”</span>
<span class="token keyword">function</span> <span class="token function">commitBeforeMutationEffects_complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> fiber <span class="token operator">=</span> nextEffect
    <span class="token function">setCurrentFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 对当前 fiberNode 执行“flags 对应的操作”</span>
      <span class="token function">commitBeforeMutationEffectsOnFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 错误处理</span>
      <span class="token function">captureCommitPhaseError</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> fiber<span class="token punctuation">.</span>return<span class="token punctuation">,</span> error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">resetCurrentFiber</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> sibling <span class="token operator">=</span> fiber<span class="token punctuation">.</span>sibling

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sibling <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果当前 fiberNode 存在兄弟 fiberNode，nextEffect 赋值为 sibling，再次走到commitBeforeMutationEffects_begin的 while 循环中</span>
      nextEffect <span class="token operator">=</span> sibling
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果当前 fiberNode 不存在兄弟 fiberNode，nextEffect 赋值为 父 fiberNode，再次走到commitBeforeMutationEffects_begin的 while 循环中</span>
    nextEffect <span class="token operator">=</span> fiber<span class="token punctuation">.</span>return
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上可以看出，如果说 render 阶段的 completeWork 会完成“自下而上”的 subtreeFlags 标记过程，那么 commit 阶段的 commitBeforeMutationEffects 会完成“自下而上”的 subtreeFlags 消费过程。</p> <h5 id="commitbeforemutationeffectsonfiber"><a href="#commitbeforemutationeffectsonfiber" class="header-anchor">#</a> commitBeforeMutationEffectsOnFiber</h5> <p>主要处理一下两种类型的 fiberNode：</p> <ul><li>ClassComponent 执行 getSnapshotBeforeUpdate 方法</li> <li>HostRoot 清空 HostRoot 挂载的内容，方便 Mutation 子阶段的渲染</li></ul> <h4 id="commitmutationeffects"><a href="#commitmutationeffects" class="header-anchor">#</a> commitMutationEffects</h4> <p>commitMutationEffects 跟 commitBeforeMutationEffects 的逻辑类似：</p> <ul><li>commitMutationEffects 会调用 commitMutationEffects_begin</li> <li>commitMutationEffects_begin 会调用 commitMutationEffects_complete
<ul><li>commitMutationEffects_begin 有特有的 commitDeletion 逻辑，用来处理“需要删除的 fiberNode”，需要考虑的事情很多：子树中所有组件的 ummout 逻辑，子树中所有 ref 属性的卸载操作，子树中所有 effect 相关 Hook 的 destory 回调执行等</li></ul></li></ul> <h5 id="commitmutationeffectsonfiber"><a href="#commitmutationeffectsonfiber" class="header-anchor">#</a> commitMutationEffectsOnFiber</h5> <ul><li>Placement flag 对应 commitPlacement 方法，执行流程分为三个步骤
<ul><li>从当前 fiberNode 向上遍历，获取第一个类型为 HostComponent、HostRoot、HostPortal 三者之一的祖先 fiberNode，其对应的 DOM 元素是“执行 DOM 操作的目标元素的父级 DOM 元素” <code>var parentFiber = getHostParentFiber(finishedWork)</code></li> <li>获取用于执行 parentNode.insertBefore(child, before) 方法的 “before 对应 DOM 元素” <code>var before = getHostSibling(finishedWork)</code></li> <li>执行 parentNode.insertBefore 方法（存在 before 的情况）或 parentNode.appendChild 方法（不存在 before 的情况）</li></ul></li> <li>Update flag 对应 commitWork 方法
<ul><li>对于 FC 等类型的 fiberNode，会执行 commitHookEffectListUnmount 和 commitHookEffectListMount 方法</li> <li>对于 HostComponent 类型的 fiberNode，会执行 commitUpdate 方法，commitUpdate 方法又会调用 updateProperties 最终会在 updateDomProperties 方法中遍历并改变对应属性，处理以下四种类型的数据
<ul><li>style 属性变化</li> <li>innerHTML</li> <li>直接文本节点变化</li> <li>其他元素属性</li></ul></li></ul></li></ul> <h4 id="commitlayouteffects"><a href="#commitlayouteffects" class="header-anchor">#</a> commitLayoutEffects</h4> <p>commitLayoutEffects 跟 commitBeforeMutationEffects 的逻辑类似：</p> <ul><li>commitLayoutEffects 会调用 commitLayoutEffects_begin</li> <li>commitLayoutEffects_begin 会调用 commitLayoutEffects_complete</li></ul> <h5 id="fiber-tree-切换"><a href="#fiber-tree-切换" class="header-anchor">#</a> Fiber Tree 切换</h5> <p>在进入 Layout 子阶段之前，会执行如下代码完成 Fiber Tree 的切换：</p> <div class="language-js extra-class"><pre class="language-js"><code>root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork
</code></pre></div><p>之所以选择这一时机切换 Fiber Tree，是因为对于 ClassComponent，当执行 componentWillUnMount 时（Mutation 子阶段），Current Fiber Tree 仍对应 UI 中的树。当执行 commponentDidMount/Update 时（Layout 子阶段），Current Fiber Tree 已经对应本次更新的 Fiber Tree。</p> <h5 id="uselayouteffect-callback-会在该阶段执行"><a href="#uselayouteffect-callback-会在该阶段执行" class="header-anchor">#</a> useLayoutEffect callback 会在该阶段执行</h5> <h5 id="commitlayouteffectsonfiber"><a href="#commitlayouteffectsonfiber" class="header-anchor">#</a> commitLayoutEffectsOnFiber</h5> <ul><li>对于 ClassComponent
<ul><li>会执行 componentDidMount 或 componentDidUpdate 方法</li> <li>执行 this.setState(newState, callback) 传递的 callback 参数会保存在对应的 fiberNode.updateQueue 中，commitLayoutEffectsOnFiber 会执行这些 callback</li></ul></li> <li>对于 FC，会执行 useLayoutEffect callback</li> <li>对于 HostRoot，执行 ReactDOM.render 传递的 callback 参数会保存在对应的 fiberNode.updateQueue 中，commitLayoutEffectsOnFiber 会执行这些 callback</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/qiqihaobenben/Front-End-Basics/edit/master/docs/frame/react/source-code.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/18/2024, 8:51:00 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f0c3bf6e.js" defer></script><script src="/assets/js/2.267df354.js" defer></script><script src="/assets/js/1.66cc43cf.js" defer></script><script src="/assets/js/142.909571e7.js" defer></script>
  </body>
</html>
